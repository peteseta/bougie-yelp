---
import {
  getCachedMetadata,
  setCachedMetadata,
} from "@utils/linkcardCache";
import { fetchLinkCardMetadata } from "@utils/fetchLinkCardMetadata";

interface Props {
  url: string;
}

const { url } = Astro.props;

async function fetchAndCacheMetadata(targetUrl: string) {
  const cached = getCachedMetadata(targetUrl);
  if (cached) return cached;

  const metadata = await fetchLinkCardMetadata(targetUrl);
  setCachedMetadata(targetUrl, metadata);
  return metadata;
}

const metadata = await fetchAndCacheMetadata(url);
---

<a
  href={url}
  target="_blank"
  rel="noopener noreferrer"
  class="group block rounded border border-skin-line bg-skin-card/50 px-5 py-5 mb-8 transition-[border-color] hover:border-skin-accent !underline-offset-[3px]"
>
  <div class="flex flex-col gap-4 sm:flex-row sm:gap-6">
    {metadata.image && (
      <div class="flex-shrink-0 self-start">
        <img
          src={metadata.image}
          alt=""
          class="h-24 w-24 rounded border border-skin-line object-cover"
        />
      </div>
    )}
    <div class="min-w-0 flex-grow">
      <div class="flex flex-col">
        <span class="text-xs font-light text-skin-base opacity-50 -mb-7">via:</span>
        <h3 class="break-words font-medium text-skin-accent decoration-dashed !underline-offset-[3px] group-hover:underline">
          {metadata.title || new URL(url).hostname}
        </h3>
      </div>
      {metadata.description && (
        <p class="mt-2 break-words text-sm text-skin-base opacity-90 line-clamp-2">
          {metadata.description}
        </p>
      )}
      <div class="mt-2.5 flex min-w-0 items-center gap-2 text-sm text-skin-base opacity-75">
        <span class="flex min-w-0 items-center gap-1.5">
          {metadata.favicon && (
            <img
              src={metadata.favicon}
              alt=""
              class="h-3.5 w-3.5"
              onerror="this.style.display='none'"
            />
          )}
          <span class="min-w-0 truncate">{new URL(url).hostname}</span>
        </span>
        <span>â†—</span>
      </div>
    </div>
  </div>
</a>
