---
import { getCollection } from "astro:content";
import postFilter from "@utils/postFilter";
import { getPlaylistTracks } from "@utils/spotify";

interface Book {
  title: string;
  author: string;
}

interface CurrentlyData {
  reading: Book[];
  listening: { spotifyPlaylistId: string };
}

const currentlyModule = await import("../data/currently.json");
const currentlyData = currentlyModule.default as CurrentlyData;

// Currently Reading
const reading: Book[] = currentlyData.reading;

// Currently Listening (Spotify)
let tracks: { title: string; artist: string }[] = [];
const playlistId = currentlyData.listening?.spotifyPlaylistId;
if (playlistId && playlistId !== "REPLACE_WITH_PLAYLIST_ID") {
  tracks = await getPlaylistTracks(playlistId);
}

// Tags with post counts
const posts = await getCollection("blog");
const filteredPosts = posts.filter(postFilter);

const tagCounts = new Map<string, { tagName: string; count: number }>();
for (const post of filteredPosts) {
  for (const tag of post.data.tags) {
    const existing = tagCounts.get(tag);
    if (existing) {
      existing.count++;
    } else {
      tagCounts.set(tag, { tagName: tag, count: 1 });
    }
  }
}

const sortedTags = [...tagCounts.entries()]
  .sort((a, b) => b[1].count - a[1].count)
  .map(([tag, { tagName, count }]) => ({ tag, tagName, count }));
---

{/* Desktop sidebar (right column) */}
<aside class="sidebar hidden lg:block">
  {reading.length > 0 && (
    <section class="mb-8">
      <h3 class="mb-3 text-sm font-semibold uppercase tracking-wider text-skin-base opacity-60">
        Reading
      </h3>
      <ul class="space-y-2">
        {reading.map(book => (
          <li class="text-sm">
            <span class="text-skin-base">{book.title}</span>
            <span class="text-skin-base opacity-50"> — {book.author}</span>
          </li>
        ))}
      </ul>
    </section>
  )}

  {tracks.length > 0 && (
    <section class="mb-8">
      <h3 class="mb-3 text-sm font-semibold uppercase tracking-wider text-skin-base opacity-60">
        Listening
      </h3>
      <ul class="space-y-2">
        {tracks.map(track => (
          <li class="text-sm">
            <span class="text-skin-base">{track.title}</span>
            <span class="text-skin-base opacity-50"> — {track.artist}</span>
          </li>
        ))}
      </ul>
    </section>
  )}

  <section>
    <h3 class="mb-3 text-sm font-semibold uppercase tracking-wider text-skin-base opacity-60">
      Topics
    </h3>
    <div class="flex flex-wrap gap-1.5">
      {sortedTags.map(({ tag, count }) => (
        <a
          href={`/tags/${tag}/`}
          class="inline-block rounded border border-skin-line px-2 py-1 text-xs text-skin-base transition-colors hover:border-skin-accent hover:text-skin-accent"
        >
          {tag}
          <span class="ml-0.5 opacity-50">{count}</span>
        </a>
      ))}
    </div>
  </section>
</aside>

{/* Mobile sticky bottom panel */}
<aside class="mobile-sidebar lg:hidden">
  {reading.length > 0 && (
    <div class="mobile-section">
      <span class="mobile-label">Something I'm Reading</span>
      <span class="mobile-scroll-text text-xs text-skin-base">{reading[0].title}<span class="opacity-50"> — {reading[0].author}</span></span>
    </div>
  )}

  {tracks.length > 0 && (
    <div class="mobile-section">
      <span class="mobile-label">Something I'm Listening To</span>
      <span class="text-xs text-skin-base">{tracks[0].title}</span>
    </div>
  )}

  <div class="mobile-section">
    <span class="mobile-label">Topics</span>
    <div class="tags-scroll">
      {sortedTags.map(({ tag, count }) => (
        <a
          href={`/tags/${tag}/`}
          class="inline-block whitespace-nowrap rounded border border-skin-line px-1.5 text-xs leading-5 text-skin-base transition-colors hover:border-skin-accent hover:text-skin-accent"
        >
          {tag}
          <span class="ml-0.5 opacity-50">{count}</span>
        </a>
      ))}
    </div>
  </div>
</aside>

<style>
  /* Desktop sidebar */
  .sidebar {
    position: sticky;
    top: 4rem;
  }

  /* Mobile sticky bottom panel */
  .mobile-sidebar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 40;
    background: rgb(var(--color-fill));
    border-top: 1px solid rgb(var(--color-border));
    padding: 0.5rem 1rem;
    backdrop-filter: blur(12px);
  }

  .mobile-section {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    padding: 0.25rem 0;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  .mobile-label {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.5;
    flex-shrink: 0;
    color: rgb(var(--color-text-base));
  }

  .mobile-scroll-text {
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .mobile-scroll-text::-webkit-scrollbar {
    display: none;
  }

  .tags-scroll {
    display: flex;
    gap: 0.375rem;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .tags-scroll::-webkit-scrollbar {
    display: none;
  }
</style>
